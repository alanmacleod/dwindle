<html>

<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
  integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
  crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
   integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
   crossorigin=""></script>

   <style>
   #map { height: 100%; width: 100%; }
</style>
</head>

<body>

  <div id="map"></div>

</body>


<script>
var alexanderplatz = [52.522032, 13.412718];
var centroid = [52.522032, 13.412718];
var map = L.map('map').setView(centroid, 6);
const AREA = 2, PREV = 3, NEXT = 4;

var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

L.tileLayer(osmUrl, {
}).addTo(map);


fetch("./data/de.4326.geo.json")
  .then(res => res.json())
  .then((data)=>{
    // console.log(data.features[0].geometry.coordinates.length);
    drawpoly(data.features[0].geometry.coordinates[90][0]);
  });

// L.marker([51.5, -0.09]).addTo(map)
//     .bindPopup('A pretty CSS3 popup.<br> Easily customizable.')
//     .openPopup();

function subset(polygon, max)
{
  let m = max || 5000;
  let out = [];
  for (let p=0; p<m; p++) out.push(polygon[p]);
  return out;
}

function drawpoly(polygon)
{
  polygon = subset(polygon, 5000);

  calcea(polygon)
  console.log("Num points: ", polygon.length);
  dwindle(polygon, 4950);
  // console.log("Removed 1000 points");

  var reduced = polygon.filter(p => {return p[NEXT]!=-1 && p[PREV]!=-1 });



  var p = L.polygon(reduced.map(c => { return [c[1], c[0]]})).addTo(map);
  map.fitBounds(p.getBounds());

}

function dwindle(polygon, numtoremove)
{
  let max = numtoremove;

  while (--max)
  {
    let p = findnext(polygon);

    // p = 4;
    let ppoint = polygon[p][PREV]; // 3
    let npoint = polygon[p][NEXT]; // 5

    // join the dots left orphaned by p's removal
    polygon[ppoint][NEXT] = polygon[p][NEXT];
    polygon[npoint][PREV] = polygon[p][PREV];

    polygon[p][PREV] = -1; // mark it as removed;
    polygon[p][NEXT] = -1; // mark it as removed;

  }

}

// replace this with minheap
// From the whole set, find the smallest area point that hasn't been removed yet
function findnext(polygon)
{
  var minarea = Number.MAX_VALUE;
  var i = -1;
  for (var p=1; p<polygon.length-1; p++)
  {
    if (polygon[p][PREV] != -1 && polygon[p][NEXT] != -1 && polygon[p][AREA] < minarea)
    {
      minarea = polygon[p][AREA];
      i = p;
    }
  }

  return i;
}

function calcea(polygon)
{
  // for each point triplet (skipping first & last)
  for (var p=1; p<polygon.length-1; p++)
  {
    var a = area([polygon[p-1], polygon[p], polygon[p+1]]);
    polygon[p][AREA] = a;
    polygon[p][PREV] = p-1; // prev
    polygon[p][NEXT] = p+1; // next
    //if (p < 5) console.log(polygon[p]);

  }
}

function area(tri)
{
  let a = length(tri[0], tri[1]);
  let b = length(tri[1], tri[2]);
  let c = length(tri[2], tri[0]);
  let s = (a + b + c) / 2;

  return Math.sqrt(
      s * (s - a) * (s - b) * (s - c)
  );

}

function length(a, b)
{
  var xdiff = b[0] - a[0];
  var ydiff = b[1] - a[1];

  return Math.sqrt( xdiff*xdiff + ydiff*ydiff );

}

    </script>
</html>
